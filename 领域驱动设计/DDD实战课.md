# 一、什么是领域驱动设计（DDD）？
DDD 是一种处理高度复杂领域的设计思想，它试图分离技术实现的复杂性，并围绕业务概念构建领域模型来控制业务的复杂性，以解决软件难以理解，难以演进的问题。
DDD 不是架构，而是一种架构设计方法论，它通过边界划分将复杂业务领域简单化，帮我们设计出清晰的领域和应用边界，可以很容易地实现架构演进。
![title](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410c9b6f0b9316e24ef335)

# 二、DDD 与微服务的关系？
DDD 是一种架构设计方法，微服务是一种架构风格，两者从本质上都是为了追求高响应力，而从业务视角去分离应用系统建设复杂度的手段。两者都强调从业务出发，其核心要义是强调根据业务发展，合理划分领域边界，持续调整现有架构，优化现有代码，以保持架构和代码的生命力，也就是我们常说的演进式架构。
DDD 主要关注：从业务领域视角划分领域边界，构建通用语言进行高效沟通，通过业务抽象，建立领域模型，维持业务和代码的逻辑一致性。
微服务主要关注：运行时的进程间通信、容错和故障隔离，实现去中心化数据管理和去中心化服务治理，关注微服务的独立开发、测试、构建和部署。

# 三、领域、子域、核心域、通用域和支撑域的概念分别是什么？
领域：就是这个边界内要解决的业务问题域。
子域：我们把划分出来的多个子领域称为子域，每个子域对应一个更小的问题域或更小的业务范围。
核心域：决定产品和公司核心竞争力的子域是核心域，它是业务成功的主要因素和公司的核心竞争力。
通用域：没有太多个性化的诉求，同时被多个子域使用的通用功能子域是通用域。
支撑域：还有一种功能子域是必需的，但既不包含决定产品和公司核心竞争力的功能，也不包含通用功能的子域，它就是支撑域。


# 四、什么是限界上下文？
限界上下文：用来封装通用语言和领域对象，提供上下文环境，保证在领域之内的一些术语、业务相关对象等（通用语言）有一个确切的含义，没有二义性。这个边界定义了模型的适用范围，使团队所有成员能够明确地知道什么应该在模型中实现，什么不应该在模型中实现。

# 五、什么是实体和值对象？
实体：领域模型中的实体是多个属性、操作或行为的载体，在代码模型中，实体的表现形式是实体类，这个类包含了实体的属性和方法，通过这些方法实现实体自身的业务逻辑。实体以 DO（领域对象）的形式存在，每个实体对象都有唯一的 ID。
值对象：通过对象属性值来识别的对象，它将多个相关属性组合为一个概念整体。
![图片标题](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410dd66f0b9316e24ef455)
![title](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410e056f0b9316e24ef483)
# 六、什么是聚合和聚合根？
聚合：是由业务和逻辑紧密关联的实体和值对象组合而成的，聚合是数据修改和持久化的基本单元，每一个聚合对应一个仓储，实现数据的持久化。
聚合根：也称为根实体，它不仅是实体，还是聚合的管理者。首先它作为实体本身，拥有实体的属性和业务行为，实现自身的业务逻辑。其次它作为聚合的管理者，在聚合内部负责协调实体和值对象按照固定的业务规则协同完成共同的业务逻辑。最后在聚合之间，它还是聚合对外的接口人，以聚合根 ID 关联的方式接受外部任务和请求，在上下文内实现聚合之间的业务协同。也就是说，聚合之间通过聚合根 ID 关联引用，如果需要访问其它聚合的实体，就要先访问聚合根，再导航到聚合内部实体，外部对象不能直接访问聚合内实体。
怎么设计聚合？
![title](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410e3c6f0b9316e24ef4b4)

# 七、什么是领域事件？
领域事件：发生后通常会导致进一步的业务操作的事件。
![图片标题](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410e6c6f0b9316e24ef4e0)
# 八、什么是DDD分层架构，其与常见的微服务架构对比如何？
DDD分层架构：最早是传统的四层架构；后来四层架构有了进一步的优化，实现了各层对基础层的解耦；再后来领域层和应用层之间增加了上下文环境（Context）层，五层架构（DCI）就此形成了。四层架构是用户接口层、应用层、领域层和基础层。
![图片标题](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410e8e6f0b9316e24ef500)

与常见的微服务架构对比：虽然 DDD 分层架构、整洁架构、六边形架构的架构模型表现形式不一样，但这三种架构模型的设计思想正是微服务架构高内聚低耦合原则的完美体现，而它们身上闪耀的正是以领域模型为中心的设计思想。这三种架构都考虑了前端需求的变与领域模型的不变。
DDD 分层架构、整洁架构、六边形架构都是以领域模型为核心，实行分层架构，内部核心业务逻辑与外部应用、资源隔离并解耦

# 九、如何用事件风暴构建领域模型？
领域建模的过程主要包括产品愿景、业务场景分析、领域建模和微服务拆分与设计。
产品愿景：主要目的是对产品顶层价值的设计，使产品目标用户、核心价值、差异化竞争点等信息达成一致，避免产品偏离方向。
业务场景分析：从用户视角出发的，根据业务流程或用户旅程，采用用例和场景分析，探索领域中的典型场景，找出领域事件、实体和命令等领域对象，支撑领域建模。事件风暴参与者要尽可能地遍历所有业务细节，充分发表意见，不要遗漏业务要点。
领域建模：根据场景分析过程中产生的领域对象，比如命令、事件等之间关系，找出产生命令的实体，分析实体之间的依赖关系组成聚合，为聚合划定限界上下文，建立领域模型以及模型之间的依赖。领域模型利用限界上下文向上可以指导微服务设计，通过聚合向下可以指导聚合根、实体和值对象的设计。
微服务拆分与设计：不能简单地将领域模型作为拆分微服务的唯一标准，它只能作为微服务拆分的一个重要依据。微服务的设计还需要考虑服务的粒度、分层、边界划分、依赖关系和集成关系。除了考虑业务职责单一外，我们还需要考虑将敏态与稳态业务的分离、非功能性需求（如弹性伸缩要求、安全性等要求）、团队组织和沟通效率、软件包大小以及技术异构等非业务因素。
![图片标题](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410f1a6f0b9316e24ef585)
![图片标题](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410f2d6f0b9316e24ef598)
![图片标题](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410f566f0b9316e24ef5be)
![图片标题](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410f636f0b9316e24ef5ca)
# 十、如何使用DDD设计微服务代码模型并保持代码与模型的一致性？
微服务代码模型就是依据 DDD 分层架构模型设计出来的。微服务一级目录是按照 DDD 分层架构的分层职责来定义的。在代码模型里分别为用户接口层、应用层、领域层和基础层，建立了 interfaces、application、domain 和 infrastructure 四个一级代码目录。
Interfaces 的代码目录结构有：assembler、dto 和 façade 三类。Assembler：实现 DTO 与领域对象之间的相互转换和数据交换。一般来说 Assembler 与 DTO 总是一同出现。Dto：它是数据传输的载体，内部不存在任何业务逻辑，我们可以通过 DTO 把内部的领域对象与外界隔离。Facade：提供较粗粒度的调用接口，将用户请求委派给一个或多个应用服务进行处理。
Application 的代码目录结构有：event 和 service。Event（事件）：这层目录主要存放事件相关的代码。它包括两个子目录：publish 和 subscribe。前者主要存放事件发布相关代码，后者主要存放事件订阅相关代码（事件处理相关的核心业务逻辑在领域层实现）。这里提示一下：虽然应用层和领域层都可以进行事件的发布和处理，但为了实现事件的统一管理，我建议你将微服务内所有事件的发布和订阅的处理都统一放到应用层，事件相关的核心业务逻辑实现放在领域层。通过应用层调用领域层服务，来实现完整的事件发布和订阅处理流程。Service（应用服务）：这层的服务是应用服务。应用服务会对多个领域服务或外部应用服务进行封装、编排和组合，对外提供粗粒度的服务。应用服务主要实现服务组合和编排，是一段独立的业务逻辑。你可以将所有应用服务放在一个应用服务类里，也可以把一个应用服务设计为一个应用服务类，以防应用服务类代码量过大。
Domain 包括：entity、event、repository 和 service 四个子目录。
Infrastructure 的代码目录结构有：config 和 util 两个子目录。

如何保持代码与模型的一致性？
1. 整理事件风暴过程中产生的各个领域对象，比如：聚合、实体、命令和领域事件等内容。
领域层的领域对象
1）设计实体
2）找出聚合根
3）设计值对象
4）设计领域事件
5）设计领域服务
6）设计仓储

应用层的领域对象
1）实体方法的封装
2）领域服务的组合和封装
3）应用服务的组合和编排

2. 建立领域对象与微服务代码对象的映射
![title](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410f8a6f0b9316e24ef5ef)

# 十一、微服务的各种边界在架构演进中的作用？
微服务的设计要涉及到逻辑边界、物理边界和代码边界等等。
逻辑边界：主要定义同一业务领域或应用内紧密关联的对象所组成的不同聚类的组合之间的边界。
物理边界：主要从部署和运行的视角来定义微服务之间的边界。不同微服务部署位置和运行环境是相互物理隔离的，分别运行在不同的进程中。这种边界就是微服务之间的物理边界。
代码边界：主要用于微服务内的不同职能代码之间的隔离。微服务开发过程中会根据代码模型建立相应的代码目录，实现不同功能代码的隔离。由于领域模型与代码模型的映射关系，代码边界直接体现出业务边界。代码边界可以控制代码重组的影响范围，避免业务和服务之间的相互影响。微服务如果需要进行功能重组，只需要以聚合代码为单位进行重组就可以了。

# 十二、如何实现服务和数据在微服务各层的协作？
服务包括：
应用服务：位于应用层。用来表述应用和用户行为，负责服务的组合、编排和转发，负责处理业务用例的执行顺序以及结果拼装，对外提供粗粒度的服务。
领域服务：位于领域层。领域服务封装核心的业务逻辑，实现需要多个实体协作的核心领域逻辑。它对多个实体或方法的业务逻辑进行组合或编排，或者在严格分层架构中对实体方法进行封装，以领域服务的方式供应用层调用。
基础服务：位于基础层。提供基础资源服务（比如数据库、缓存等），实现各层的解耦，降低外部资源变化对业务应用逻辑的影响。基础服务主要为仓储服务，通过依赖倒置提供基础资源服务。领域服务和应用服务都可以调用仓储服务接口，通过仓储服务实现数据持久化。
服务的调用应该满足严格分层架构的服务依赖。

数据对象包括：
数据持久化对象 PO(Persistent Object)，与数据库结构一一映射，是数据持久化过程中的数据载体。
领域对象 DO（Domain Object），微服务运行时的实体，是核心业务的载体。
数据传输对象 DTO（Data Transfer Object），用于前端与应用层或者微服务之间的数据组装和传输，是应用之间数据传输的载体。
视图对象 VO（View Object），用于封装展示层指定页面或组件的数据。
![title](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410f9c6f0b9316e24ef600)

# 十三、微服务后，前端如何设计？
在前端设计时我们需要遵循单一职责和复用原则，按照领域模型和微服务边界，将前端页面进行拆分。同时构建多个可以独立部署、完全自治、松耦合的页面组合，其中每个组合只负责特定业务单元的 UI 元素和功能，这些页面组合就是微前端。
微前端位于前端主页面和微服务之间，它需要与两者完成集成。
前端项目团队只需要完成企业级前端主页面与业务单元的融合，前端只关注前端主页面与微前端页面之间的集成。这样就可以降低前端团队的技术敏感度、团队的沟通成本和集成复杂度，提高交付效率和用户体验。
中台项目团队关注业务单元功能的完整性和自包含能力，完成业务单元内微服务和微前端开发、集成和部署，提供业务单元组件。
![title](https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5e410fb46f0b9316e24ef619)

# 十四、基于DDD的微服务设计流程是怎样的？
战略+战术设计
战略设计是根据用户旅程分析，找出领域对象和聚合根，对实体和值对象进行聚类组成聚合，划分限界上下文，建立领域模型的过程。战略设计采用的方法是事件风暴，包括：产品愿景、场景分析、领域建模和微服务拆分等几个主要过程。
产品愿景：对产品顶层价值设计，对产品目标用户、核心价值、差异化竞争点等信息达成一致，避免产品偏离方向。
场景分析：从用户视角出发，探索业务领域中的典型场景，产出领域中需要支撑的场景分类、用例操作以及不同子域之间的依赖关系，用以支撑领域建模。
领域建模：通过对业务和问题域进行分析，建立领域模型。向上通过限界上下文指导微服务边界设计，向下通过聚合指导实体对象设计。领域建模是一个收敛的过程，分三步：第一步找出领域实体和值对象等领域对象；第二步找出聚合根，根据实体、值对象与聚合根的依赖关系，建立聚合；第三步根据业务及语义边界等因素，定义限界上下文。

战术设计是根据领域模型进行微服务设计的过程。这个阶段主要梳理微服务内的领域对象，梳理领域对象之间的关系，确定它们在代码模型和分层架构中的位置，建立领域模型与微服务模型的映射关系，以及服务之间的依赖关系。
1）分析微服务领域对象：
我们分析微服务内应该有哪些服务？服务的分层？应用服务由哪些服务组合和编排完成？领域服务包括哪些实体和实体方法？哪个实体是聚合根？实体有哪些属性和方法？哪些对象应该设计为值对象等。
2）设计微服务代码结构
应用层包括：应用服务、DTO 以及事件发布相关代码。
领域层包括一个或多个聚合的实体类、事件实体类、领域服务以及工厂、仓储相关代码。

后续的工作
1）详细设计在完成领域模型和微服务设计后，我们还需要对微服务进行详细的设计。主要设计以下内容：实体属性、数据库表和字段、实体与数据库表映射、服务参数规约及功能实现等。
2）代码开发和测试开发人员只需要按照详细的设计文档和功能要求，找到业务功能对应的代码位置，完成代码开发就可以了。代码开发完成后，开发人员要编写单元测试用例，基于挡板模拟依赖对象完成服务测试。
